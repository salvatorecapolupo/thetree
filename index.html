<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>The Larch!</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f0f0f0;
      text-align: center;
      margin: 20px;
    }
    #tree {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .level {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .node {
      width: 140px;
      min-height: 40px;
      border: 2px dashed #888;
      border-radius: 8px;
      background-color: white;
      line-height: 40px;
      padding: 5px;
    }
    .correct {
      background-color: #a8f5a2 !important;
    }
    .wrong {
      background-color: #a2c6f5 !important;
    }
    #bucket {
      margin-top: 30px;
      padding: 10px;
      border: 2px solid #555;
      background: #fffbe6;
      min-height: 60px;
    }
    .label {
      display: inline-block;
      margin: 5px;
      padding: 5px 10px;
      background: #ddd;
      border-radius: 5px;
      cursor: grab;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h1>Costruisci l'Albero da JSON</h1>
  <div id="tree"></div>

  <h2>Cesta delle Etichette</h2>
  <div id="bucket"></div>

  <button onclick="checkTree()">Verifica</button>

  <script>
    let correctMap = {};
    let labels = [];

    async function loadJSONTree() {
      const res = await fetch("https://salvatorecapolupo.github.io/thetree/tree.json");
      const data = await res.json();
      generateFromJSON(data);
    }

    function generateFromJSON(data) {
      const tree = document.getElementById("tree");
      const bucket = document.getElementById("bucket");
      tree.innerHTML = "";
      bucket.innerHTML = "";
      correctMap = {};
      labels = [];

      const level1 = document.createElement("div");
      level1.className = "level";
      Object.keys(data).forEach((serie, i) => {
        const node = createDroppableNode(`L1-${i}`, serie);
        level1.appendChild(node);
        correctMap[`L1-${i}`] = serie;
        labels.push(serie);
      });
      tree.appendChild(level1);

      const level2 = document.createElement("div");
      level2.className = "level";
      let l2Count = 0;
      Object.entries(data).forEach(([serie, squadre]) => {
        Object.keys(squadre).forEach(squadra => {
          const node = createDroppableNode(`L2-${l2Count}`, squadra);
          level2.appendChild(node);
          correctMap[`L2-${l2Count}`] = squadra;
          labels.push(squadra);
          l2Count++;
        });
      });
      tree.appendChild(level2);

      const level3 = document.createElement("div");
      level3.className = "level";
      let l3Count = 0;
      Object.entries(data).forEach(([serie, squadre]) => {
        Object.values(squadre).forEach(giocatori => {
          giocatori.forEach(giocatore => {
            const node = createDroppableNode(`L3-${l3Count}`, giocatore);
            level3.appendChild(node);
            correctMap[`L3-${l3Count}`] = giocatore;
            labels.push(giocatore);
            l3Count++;
          });
        });
      });
      tree.appendChild(level3);

      // Mescola e crea le etichette
      shuffleArray(labels).forEach(text => {
        const label = document.createElement("span");
        label.className = "label";
        label.textContent = text;
        label.draggable = true;
        label.ondragstart = drag;
        bucket.appendChild(label);
      });
    }

    function createDroppableNode(id, content = "") {
      const node = document.createElement("div");
      node.className = "node";
      node.dataset.slot = id;
      node.textContent = "";
      node.ondragover = e => e.preventDefault();
      node.ondrop = drop;
      return node;
    }

    function drag(e) {
      e.dataTransfer.setData("text", e.target.textContent);
    }

    function drop(e) {
      e.preventDefault();
      const data = e.dataTransfer.getData("text");

      // Se giÃ  contiene qualcosa, lo rimette nel bucket
      if (e.target.textContent.trim() !== "") {
        const old = e.target.textContent;
        const span = document.createElement("span");
        span.className = "label";
        span.textContent = old;
        span.draggable = true;
        span.ondragstart = drag;
        document.getElementById("bucket").appendChild(span);
      }

      e.target.textContent = data;

      // Rimuove la label dal bucket
      [...document.querySelectorAll("#bucket .label")].forEach(el => {
        if (el.textContent === data) el.remove();
      });
    }

    function checkTree() {
      document.querySelectorAll(".node").forEach(node => {
        const expected = correctMap[node.dataset.slot];
        const actual = node.textContent.trim();
        node.classList.remove("correct", "wrong");
        if (!actual) return;
        if (expected === actual) {
          node.classList.add("correct");
        } else {
          node.classList.add("wrong");
        }
      });
    }

    function shuffleArray(arr) {
      let array = arr.slice();
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    loadJSONTree();
  </script>
</body>
</html>
