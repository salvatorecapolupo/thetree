<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>THE LARCH</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #f8f9fa;
    }

    .node-slot, .draggable {
      min-width: 120px;
      min-height: 40px;
      padding: 0.5em;
      margin: 1em;
      border-radius: 8px;
      text-align: center;
    }

    .node-slot {
      border: 2px dashed #adb5bd;
      background: white;
      cursor: pointer;
      position: relative;
    }

    .node-slot.correct {
      background-color: #d4edda !important;
      border-color: #28a745;
    }

    .node-slot.wrong {
      background-color: #f8d7da !important;
      border-color: #dc3545;
    }

    .draggable {
      background: #dee2e6;
      cursor: grab;
    }

    .tree-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      margin-bottom: 3rem;
    }

    .tree-level {
      display: flex;
      justify-content: center;
      margin: 2rem 0;
      position: relative;
    }

    #pool {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1em;
      margin-top: 2em;
      padding: 1em;
      border-top: 2px solid #ccc;
    }

    .drop-hover {
      background-color: #e2f0ff !important;
    }

    h1, h2 {
      text-align: center;
    }

    #result {
      text-align: center;
      font-size: 1.2rem;
      margin-top: 1em;
    }

    img.footer {
      display: block;
      margin: 3rem auto 0;
      max-width: 300px;
    }
  </style>
</head>
<body class="container py-4">

  <h1>THE LARCH ðŸŒ²</h1>
  <p class="text-center">Trascina le etichette nelle posizioni corrette dellâ€™albero gerarchico.</p>

  <div class="tree-container" id="tree"></div>

  <h2>Cesta</h2>
  <div id="pool"></div>

  <div class="text-center">
    <button class="btn btn-primary mt-3" onclick="checkTree()">Verifica</button>
    <div id="result"></div>
  </div>

  <img src="./the_larch.gif" alt="The Larch" class="footer" />

  <script>
    const treeData = {
      "Serie A": {
        "Milan": {
          "Maldini": {},
          "Van Basten": {}
        },
        "Juventus": {
          "Del Piero": {},
          "Buffon": {}
        }
      }
    };

    const allLabels = [];

    // Ricava una lista ordinata di livelli e aspettative
    function buildTreeUI(tree, container, level = 0) {
      const levelDiv = document.getElementById("level-" + level) || document.createElement("div");
      levelDiv.className = "tree-level";
      levelDiv.id = "level-" + level;

      for (const key in tree) {
        const slot = document.createElement("div");
        slot.className = "node-slot";
        slot.dataset.expect = key;
        slot.dataset.level = level;
        slot.addEventListener("dragover", dragOver);
        slot.addEventListener("drop", dropHandler);
        slot.addEventListener("dragleave", dragLeave);
        levelDiv.appendChild(slot);
        allLabels.push(key);

        buildTreeUI(tree[key], container, level + 1);
      }

      if (!document.getElementById(levelDiv.id)) {
        container.appendChild(levelDiv);
      }
    }

    function createDraggable(text) {
      const el = document.createElement("div");
      el.className = "draggable";
      el.setAttribute("draggable", "true");
      el.textContent = text;
      el.addEventListener("dragstart", dragStart);
      return el;
    }

    function dragStart(e) {
      e.dataTransfer.setData("text/plain", e.target.textContent);
      e.dataTransfer.effectAllowed = "move";
      document.querySelectorAll(".draggable").forEach(el => el.classList.remove("being-dragged"));
      e.target.classList.add("being-dragged");
    }

    function dropHandler(e) {
      e.preventDefault();
      e.target.classList.remove("drop-hover");

      const label = e.dataTransfer.getData("text/plain");
      const draggedEl = document.querySelector(".draggable.being-dragged");

      if (!draggedEl || e.target.querySelector(".draggable")) return;

      // Rimuovi da origine
      draggedEl.remove();

      // Inserisci nello slot
      const newEl = createDraggable(label);
      e.target.innerHTML = "";
      e.target.appendChild(newEl);
    }

    function dragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
      e.target.classList.add("drop-hover");
    }

    function dragLeave(e) {
      e.target.classList.remove("drop-hover");
    }

    function checkTree() {
      let correct = 0;
      const total = allLabels.length;

      document.querySelectorAll(".node-slot").forEach(slot => {
        slot.classList.remove("correct", "wrong");

        const expected = slot.dataset.expect;
        const placed = slot.querySelector(".draggable")?.textContent;

        if (placed === expected) {
          correct++;
          slot.classList.add("correct");
        } else if (placed) {
          slot.classList.add("wrong");
        }
      });

      const result = document.getElementById("result");
      result.textContent = `${correct} su ${total} corretti`;

      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      osc.type = "square";
      osc.frequency.setValueAtTime(correct === total ? 880 : 220, ctx.currentTime);
      osc.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + 0.2);
    }

    // INIT
    buildTreeUI(treeData, document.getElementById("tree"));

    // Shuffle e riempi la cesta
    const pool = document.getElementById("pool");
    allLabels.sort(() => Math.random() - 0.5);
    allLabels.forEach(label => pool.appendChild(createDraggable(label)));
  </script>

</body>
</html>
